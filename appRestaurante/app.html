<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedido - La rueda del sabor</title>
  <style>
    :root{--accent:#ff6b00;--bg:#fafafa;--card:#fff;--muted:#666}
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, sans-serif}
    body{margin:0;background:var(--bg);color:#111}
    header{background:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;border-bottom:1px solid #eee}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:1.1rem;margin:0}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:18px;max-width:1200px;margin:18px auto}
    main{min-height:60vh}
    .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(10,10,10,0.04)}
    .card h3{margin:0 0 6px 0;font-size:1rem}
    .price{font-weight:700;margin-top:8px}
    .controls{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .product-img{width:100%;height:120px;object-fit:cover;margin-bottom:6px;border-radius:6px}
    button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #ffd9c7}
    .cart{position:sticky;top:18px}
    .cart h2{margin:0 0 8px 0}
    .cart-list{max-height:52vh;overflow:auto;margin-bottom:10px}
    .cart-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-bottom:1px dashed #eee}
    .qty{display:flex;gap:6px;align-items:center}
    input[type="tel"], input[type="text"], input[type="number"], textarea, select {width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
    .summary{background:#fff;padding:10px;border-radius:10px;border:1px solid #eee}
    footer{padding:16px;text-align:center;color:var(--muted);font-size:0.9rem}
    .admin-panel{margin-bottom:12px}
    .admin-controls{display:flex;gap:8px;align-items:center}
    .small{font-size:0.85rem;color:var(--muted)}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .hidden{display:none}
    .actions {display:flex;gap:8px;margin-top:8px}
    @media(max-width:920px){.layout{grid-template-columns:1fr;padding:12px}.cart{position:static;margin-top:12px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">RR</div>
      <div>
        <h1>Restaurante La Rueda Del Sabor</h1>
        <div class="small">Pide por teléfono o WhatsApp — listo para recoger</div>
      </div>
    </div>
    <div style="margin-left:auto;font-size:0.9rem;color:var(--muted)">Tel: <strong id="rest-phone">+593984056262</strong></div>
  </header>

  <div class="layout">
    <main>
      <!-- ADMIN: show/hide -->
      <section class="card admin-panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Administración</strong>
            <div class="small">Sólo tú puedes agregar/editar/eliminar productos</div>
          </div>
          <div class="admin-controls">
            <button id="btn-admin-toggle" class="ghost">Entrar como Admin</button>
            <button id="btn-logout" class="ghost hidden">Salir</button>
          </div>
        </div>

        <div id="admin-area" class="hidden" style="margin-top:12px">
          <form id="product-form" style="display:grid;gap:8px">
            <input id="p-id" type="hidden">
            <input id="p-name" type="text" placeholder="Nombre del producto" required>
            <div class="row">
              <input id="p-price-dinein" type="number" step="0.01" placeholder="Precio Servirse (ej. 2.00)" required>
              <input id="p-price-takeout" type="number" step="0.01" placeholder="Precio Llevar (ej. 2.25)" required>
            </div>
            <textarea id="p-desc" rows="2" placeholder="Descripción (opcional)"></textarea>
            <input id="p-img" type="text" placeholder="URL de imagen (opcional)">
            <div class="actions">
              <button type="submit" id="save-product">Guardar producto</button>
              <button type="button" id="cancel-edit" class="ghost">Cancelar</button>
              <button type="button" id="clear-products" class="ghost">Borrar todo (menu)</button>
            </div>
          </form>
          <div style="margin-top:12px" class="small">Consejo: la contraseña admin está en el código (puedes cambiarla).</div>
        </div>
      </section>

      <section class="card">
        <h2>Menú</h2>
        <div class="small" style="margin-bottom:8px">Los clientes sólo pueden elegir Servirse o Llevar y agregar al carrito.</div>
        <div class="menu-grid" id="menu"></div>
      </section>

      <section class="card" style="margin-top:12px">
        <h2>Instrucciones / Notas</h2>
        <textarea id="notes" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></textarea>
      </section>
    </main>

    <aside class="cart card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Tu Pedido</h2>
        <button class="ghost" id="clear-cart">Limpiar</button>
      </div>
      <div class="cart-list" id="cart-list"></div>
      <div class="summary">
        <label for="customer-name">Nombre:</label>
        <input id="customer-name" type="text" placeholder="Nombre del cliente" />
        <label for="customer-phone" style="margin-top:8px;display:block">Teléfono (móvil):</label>
        <input id="customer-phone" type="tel" placeholder="+593984056262" />
        <hr style="margin:10px 0;border:none;border-top:1px solid #f0f0f0" />
        <div style="display:flex;justify-content:space-between;align-items:center"><div>Subtotal</div><div id="subtotal">$0.00</div></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-weight:700"><div>Total</div><div id="total">$0.00</div></div>
        <div style="margin-top:10px;display:grid;gap:8px">
          <button id="whatsapp">Enviar por WhatsApp</button>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    * Admin: agrega tus productos con ambos precios y opcional imagen. Clientes solo eligen y piden.
  </footer>

  <script>
    const ADMIN_PASSWORD='12345678910domenica';
    const REST_PHONE='+593984056262';
    document.getElementById('rest-phone').textContent=REST_PHONE;

    let MENU=JSON.parse(localStorage.getItem('pedido_menu')||'[]');
    let cart=JSON.parse(localStorage.getItem('pedido_cart')||'[]');
    let isAdmin=localStorage.getItem('pedido_isAdmin')==='true';

    const menuEl=document.getElementById('menu');
    const cartList=document.getElementById('cart-list');
    const subtotalEl=document.getElementById('subtotal');
    const totalEl=document.getElementById('total');
    const adminArea=document.getElementById('admin-area');
    const btnAdminToggle=document.getElementById('btn-admin-toggle');
    const btnLogout=document.getElementById('btn-logout');
    const productForm=document.getElementById('product-form');
    const pId=document.getElementById('p-id');
    const pName=document.getElementById('p-name');
    const pPriceDineIn=document.getElementById('p-price-dinein');
    const pPriceTakeOut=document.getElementById('p-price-takeout');
    const pDesc=document.getElementById('p-desc');
    const pImg=document.getElementById('p-img');
    const btnCancelEdit=document.getElementById('cancel-edit');
    const btnClearProducts=document.getElementById('clear-products');

    function renderMenu(){
      menuEl.innerHTML='';
      if(MENU.length===0){ menuEl.innerHTML='<div style="color:var(--muted)">Sin productos aún</div>'; return; }
      MENU.forEach(item=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          ${item.img?`<img src="${encodeURI(item.img)}" class="product-img">`:''}
          <h3>${escapeHtml(item.name)}</h3>
          <div style="font-size:0.9rem;color:var(--muted)">${escapeHtml(item.desc||'')}</div>
          <div style="margin-top:6px;font-size:0.9rem">Servirse: <strong>$${Number(item.priceDineIn).toFixed(2)}</strong></div>
          <div style="font-size:0.9rem">Llevar: <strong>$${Number(item.priceTakeOut).toFixed(2)}</strong></div>
          <div class="controls">
            <label><input type="radio" name="opt-${item.id}" value="dineIn" checked> Servirse</label>
            <label><input type="radio" name="opt-${item.id}" value="takeOut"> Llevar</label>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <button data-id="${item.id}" class="add">Agregar</button>
              ${isAdmin?`<button data-id="${item.id}" class="edit ghost">Editar</button>
                          <button data-id="${item.id}" class="delete ghost">Eliminar</button>`:''}
            </div>
          </div>
        `;
        menuEl.appendChild(card);
      });
    }

    function renderCart(){
      cartList.innerHTML='';
      if(cart.length===0){ cartList.innerHTML='<div style="color:var(--muted)">Carrito vacío</div>'; updateTotals(); return; }
      cart.forEach((it,idx)=>{
        const row=document.createElement('div'); row.className='cart-item';
        row.innerHTML=`
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(it.name)} (${it.option==='dineIn'?'Servirse':'Llevar'})</div>
            <div style="font-size:0.85rem;color:var(--muted)">$${Number(it.price).toFixed(2)}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;min-width:120px">
            <div class="qty">
              <button class="dec" data-idx="${idx}">-</button>
              <div style="padding:4px 8px;border-radius:6px;background:#f6f6f6">${it.qty}</div>
              <button class="inc" data-idx="${idx}">+</button>
            </div>
            <div style="margin-top:6px">$${(Number(it.price)*it.qty).toFixed(2)}</div>
          </div>
        `;
        cartList.appendChild(row);
      });
      updateTotals();
    }

    function updateTotals(){
      const subtotal=cart.reduce((s,i)=>s+Number(i.price)*i.qty,0);
      subtotalEl.textContent=`$${subtotal.toFixed(2)}`;
      totalEl.textContent=`$${subtotal.toFixed(2)}`;
    }

    function saveMenu(){ localStorage.setItem('pedido_menu',JSON.stringify(MENU)); }
    function saveCart(){ localStorage.setItem('pedido_cart',JSON.stringify(cart)); }
    function setAdmin(val){ isAdmin=!!val; localStorage.setItem('pedido_isAdmin',isAdmin?'true':'false'); renderUIByRole(); renderMenu(); }
    function escapeHtml(text){ if(!text) return ''; return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    document.body.addEventListener('click',(e)=>{
      if(e.target.matches('.add')){
        const id=Number(e.target.dataset.id);
        const item=MENU.find(x=>x.id===id); if(!item) return;
        const opt=document.querySelector(`input[name="opt-${id}"]:checked`).value;
        const price=opt==='dineIn'?Number(item.priceDineIn):Number(item.priceTakeOut);
        const existing=cart.find(x=>x.id===id&&x.option===opt);
        if(existing) existing.qty++; else cart.push({id:item.id,name:item.name,option:opt,price,qty:1});
        saveCart(); renderCart();
      }
      if(e.target.matches('.inc')||e.target.matches('.dec')){
        const idx=Number(e.target.dataset.idx); if(isNaN(idx)) return;
        if(e.target.matches('.inc')) cart[idx].qty++; else { cart[idx].qty--; if(cart[idx].qty<=0) cart.splice(idx,1); }
        saveCart(); renderCart();
      }
      if(e.target.matches('.edit')){
        const id=Number(e.target.dataset.id);
        const prod=MENU.find(x=>x.id===id); if(!prod) return;
        pId.value=prod.id; pName.value=prod.name; pPriceDineIn.value=prod.priceDineIn;
        pPriceTakeOut.value=prod.priceTakeOut; pDesc.value=prod.desc||''; pImg.value=prod.img||'';
        adminArea.scrollIntoView({behavior:'smooth'});
      }
      if(e.target.matches('.delete')){
        if(!confirm('¿Eliminar este producto?')) return;
        const id=Number(e.target.dataset.id);
        MENU=MENU.filter(x=>x.id!==id); saveMenu(); renderMenu();
      }
    });

    btnAdminToggle.addEventListener('click',()=>{
      if(isAdmin) return;
      const pwd=prompt('Ingresa contraseña de administrador');
      if(pwd===ADMIN_PASSWORD){ setAdmin(true); alert('Modo administrador activado'); }
      else alert('Contraseña incorrecta');
    });

    btnLogout.addEventListener('click',()=>{
      if(confirm('Cerrar sesión de administrador?')){ setAdmin(false); alert('Sesión admin cerrada'); }
    });

    productForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      if(!isAdmin){ alert('No tienes permiso para agregar productos. Entra como admin.'); return; }
      const idVal=pId.value?Number(pId.value):null;
      const name=pName.value.trim();
      const priceDineIn=parseFloat(pPriceDineIn.value);
      const priceTakeOut=parseFloat(pPriceTakeOut.value);
      const desc=pDesc.value.trim();
      const img=pImg.value.trim();
      if(!name||isNaN(priceDineIn)||isNaN(priceTakeOut)){ alert('Completa nombre y precios válidos'); return; }
      if(idVal){
        const idx=MENU.findIndex(x=>x.id===idVal); if(idx!==-1){ MENU[idx]={...MENU[idx],name,priceDineIn,priceTakeOut,desc,img}; }
      } else { MENU.push({id:Date.now(),name,priceDineIn,priceTakeOut,desc,img}); }
      saveMenu(); renderMenu(); productForm.reset(); pId.value=''; pImg.value='';
    });

    btnCancelEdit.addEventListener('click',()=>{ productForm.reset(); pId.value=''; pImg.value=''; });
    btnClearProducts.addEventListener('click',()=>{ if(!isAdmin) return alert('Permiso denegado'); if(confirm('Borrar TODO el menú? Esta acción no tiene deshacer.')){ MENU=[]; saveMenu(); renderMenu(); } });
    document.getElementById('clear-cart').addEventListener('click',()=>{ if(confirm('Limpiar carrito?')){ cart=[]; saveCart(); renderCart(); } });

    // --- CORRECCIÓN WHATSAPP ---
    document.getElementById('whatsapp').addEventListener('click',()=>{
      if(cart.length===0) return alert('Tu pedido está vacío');
      const clientName=document.getElementById('customer-name').value.trim();
      const clientPhone=document.getElementById('customer-phone').value.trim();
      const notes=document.getElementById('notes').value.trim();
      const subtotal=cart.reduce((s,i)=>s+Number(i.price)*i.qty,0);

      const lines=[];
      lines.push(`*Pedido - Restaurante La Rueda del Sabor*`);
      lines.push(`Cliente: ${clientName||'---'}`);
      lines.push(`Tel: ${clientPhone||'---'}`);
      lines.push('');
      lines.push('Pedido:');
      cart.forEach(i=>{
        lines.push(`${i.qty} x ${i.name} (${i.option==='dineIn'?'Servirse':'Llevar'}) - $${(Number(i.price)*i.qty).toFixed(2)}`);
      });
      lines.push('');
      lines.push(`Subtotal: $${subtotal.toFixed(2)}`);
      lines.push(`*Total: $${subtotal.toFixed(2)}*`);
      if(notes) { lines.push(''); lines.push(`Notas: ${notes}`); }

      const text=encodeURIComponent(lines.join('\n'));
      const phone = REST_PHONE.replace(/[^0-9]/g,'');
      const waURL = `https://wa.me/${phone}?text=${text}`;
      window.open(waURL,'_blank');
    });

    function renderUIByRole(){ if(isAdmin){ adminArea.classList.remove('hidden'); btnAdminToggle.classList.add('hidden'); btnLogout.classList.remove('hidden'); } else { adminArea.classList.add('hidden'); btnAdminToggle.classList.remove('hidden'); btnLogout.classList.add('hidden'); } }

    renderUIByRole(); renderMenu(); renderCart();
  </script>
</body>
</html>
